<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lender Product Matrix v2</title>
    <style>
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #172c40;
            line-height: 1.6;
        }

        /* Header Styles */
        .header {
            background: #172c40;
            color: white;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header-results-summary {
            background: #5affc4;
            border: 2px solid #172c40;
            color: #172c40;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            width: 120px;
            text-align: center;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-clear-filters {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-clear-filters:hover {
            background: #c82333;
        }

        /* Filter Section Styles */
        .filter-container {
            background: #f8f9fa;
            border: 4px solid #5affc4;
            margin: 1rem;
            border-radius: 8px;
            overflow: visible;
        }

        .filter-content {
            padding: 0.75rem;
            overflow: visible;
        }

        .filter-rows {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 0.15rem;
            color: #172c40;
            font-size: 0.85rem;
        }

        /* Input Styles */
        .filter-input {
            padding: 0.4rem;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            height: 38px;
            width: 100%;
        }

        .filter-input:focus {
            outline: none;
            border-color: #5affc4;
            box-shadow: 0 0 0 3px rgba(90, 255, 196, 0.1);
        }

        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #5affc4;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }

        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        /* Multi-Select Styles */
        .multi-select {
            position: relative;
        }

        .multi-select-display {
            padding: 0.4rem;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            height: 38px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: center;
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .multi-select-display:hover,
        .multi-select-display:focus {
            outline: none;
            border-color: #5affc4;
            box-shadow: 0 0 0 3px rgba(90, 255, 196, 0.1);
        }

        .multi-select-display::after {
            content: "▼";
            margin-left: auto;
            color: #6c757d;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .multi-select.open .multi-select-display::after {
            transform: rotate(180deg);
        }

        .multi-select-placeholder {
            color: #6c757d;
            font-size: 0.85rem;
            font-weight: normal;
            opacity: 1;
        }

        .multi-select-tag {
            background: #5affc4;
            color: #172c40;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .multi-select-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #5affc4;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-option {
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid #f8f9fa;
        }

        .multi-select-option:hover {
            background-color: #f8f9fa;
        }

        /* Single Select Styles */
        .single-select {
            position: relative;
        }

        .single-select-display {
            padding: 0.4rem;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            height: 38px;
            display: flex;
            align-items: center;
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .single-select-display::after {
            content: "▼";
            margin-left: auto;
            color: #6c757d;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .single-select.open .single-select-display::after {
            transform: rotate(180deg);
        }

        .single-select-placeholder {
            color: #6c757d;
            font-size: 0.85rem;
            font-weight: normal;
            opacity: 1;
        }

        .single-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #5affc4;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .single-select-dropdown.show {
            display: block;
        }

        .single-select-option {
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f8f9fa;
        }

        .single-select-option:hover {
            background-color: #f8f9fa;
        }

        /* Results Table Styles */
        .results-container {
            margin: 1rem;
        }

        .results-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th, td {
            padding: 0.3rem 0.25rem;
            text-align: left;
            border-bottom: 3px solid #dee2e6;
            font-size: 0.85rem;
            vertical-align: top;
            word-wrap: break-word;
        }

        th:last-child, td:last-child {
            border-right: none;
        }

        th:nth-child(1), td:nth-child(1) { width: 14%; }  /* Lender - keep current */
        th:nth-child(2), td:nth-child(2) { width: 11%; }  /* Funding - keep current */
        th:nth-child(3), td:nth-child(3) { width: 25%; }  /* Key Criteria - equal split of remaining */
        th:nth-child(4), td:nth-child(4) { width: 25%; }  /* Key Documents - equal split of remaining */
        th:nth-child(5), td:nth-child(5) { width: 25%; }  /* Security - equal split of remaining */
        th:nth-child(6), td:nth-child(6) { width: 25%; }  /* Product USP - equal split of remaining */

        th {
            background: #172c40;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .lender-name {
            font-weight: bold;
            color: #172c40;
            text-align: left;
        }

        .product-badge {
            display: inline-block;
            background: #17a2b8;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 0.125rem;
            white-space: nowrap;
        }

        .submission-link {
            color: #007bff;
            text-decoration: none;
            text-align: left;
            display: inline-block;
        }

        /* Panel Indicator Styles */
        .panel-indicators {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .panel-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            text-align: center;
        }

        .panel-indicator.mint-finance {
            background-color: #172c40; /* Same blue as header */
            color: #5affc4; /* Mint green color */
        }

        .panel-indicator.elite-money {
            background-color: #ffd700; /* Gold color */
            color: #172c40; /* Same blue as header */
        }

        .amount-range {
            color: #28a745;
            font-weight: 600;
        }

        .term-range {
            color: #17a2b8;
            font-weight: 600;
        }

        .criteria-list, .documents-list, .security-list, .usp-list {
            list-style: none;
            padding: 0;
        }

        .criteria-list li, .documents-list li, .security-list li, .usp-list li {
            padding: 0.125rem 0;
            font-size: 0.85rem;
        }

        .criteria-list li:before, .documents-list li:before, .security-list li:before, .usp-list li:before {
            content: "• ";
            color: #172c40;
            font-weight: bold;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .footer {
            background: #172c40;
            color: white;
            padding: 0.5rem;
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .footer p {
            margin: 0;
            font-size: 0.75rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .filter-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .filter-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="header-results-summary" id="headerResultsSummary">
                Loading...
            </div>
        </div>
        <div class="header-center">
            <h1>Lender Product Matrix v2</h1>
        </div>
        <div class="header-right">
            <button class="header-clear-filters" onclick="clearAllFilters()">Clear Filters</button>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-container">
        <div class="filter-content">
            <div class="filter-rows">
                <!-- Row 1 -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="lenderSearch">Lender</label>
                        <div class="autocomplete-container">
                            <input type="text" id="lenderSearch" class="filter-input" placeholder="Type lender name...">
                            <div class="autocomplete-dropdown" id="lenderAutocomplete"></div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="loanAmount">Loan Amount (£)</label>
                        <input type="number" id="loanAmount" class="filter-input" placeholder="Enter loan amount..." min="0" max="5000000" step="1000">
                    </div>

                    <div class="filter-group">
                        <label for="termMonths">Term (Months)</label>
                        <input type="number" id="termMonths" class="filter-input" placeholder="Enter term in months..." min="0">
                    </div>

                    <div class="filter-group">
                        <label for="tradingTime">Trading (Months)</label>
                        <input type="number" id="tradingTime" class="filter-input" placeholder="Enter trading timeframe in months..." min="0">
                    </div>

                    <div class="filter-group">
                        <label for="monthlyTurnover">Turnover (£ per month)</label>
                        <input type="number" id="monthlyTurnover" class="filter-input" placeholder="Enter monthly turnover..." min="0" max="5000000" step="1000">
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="productType">Product Type</label>
                        <div class="multi-select" id="productTypeSelect">
                            <div class="multi-select-display" onclick="toggleMultiSelect('productType')">
                                <span class="multi-select-placeholder">Select product type...</span>
                            </div>
                            <div class="multi-select-dropdown" id="productTypeDropdown"></div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="companyType">Company Type</label>
                        <div class="multi-select" id="companyTypeSelect">
                            <div class="multi-select-display" onclick="toggleMultiSelect('companyType')">
                                <span class="multi-select-placeholder">Select company type...</span>
                            </div>
                            <div class="multi-select-dropdown" id="companyTypeDropdown"></div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="location">Location</label>
                        <div class="multi-select" id="locationSelect">
                            <div class="multi-select-display" onclick="toggleMultiSelect('location')">
                                <span class="multi-select-placeholder">Select location...</span>
                            </div>
                            <div class="multi-select-dropdown" id="locationDropdown"></div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="pgRequirement">PG Required</label>
                        <div class="single-select" id="pgRequirementSelect">
                            <div class="single-select-display" onclick="toggleSingleSelect('pgRequirement')">
                                <span class="single-select-placeholder">Select PG required...</span>
                            </div>
                            <div class="single-select-dropdown" id="pgRequirementDropdown">
                                <div class="single-select-option" onclick="selectSingleOption('pgRequirement', 'yes')">Yes</div>
                                <div class="single-select-option" onclick="selectSingleOption('pgRequirement', 'no')">No</div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="homeownerRequirement">Homeowner Requirement</label>
                        <div class="single-select" id="homeownerRequirementSelect">
                            <div class="single-select-display" onclick="toggleSingleSelect('homeownerRequirement')">
                                <span class="single-select-placeholder">Select homeowner requirement...</span>
                            </div>
                            <div class="single-select-dropdown" id="homeownerRequirementDropdown">
                                <div class="single-select-option" onclick="selectSingleOption('homeownerRequirement', 'either')">Either</div>
                                <div class="single-select-option" onclick="selectSingleOption('homeownerRequirement', 'yes')">Yes</div>
                                <div class="single-select-option" onclick="selectSingleOption('homeownerRequirement', 'no')">No</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-container">
        <div class="results-table">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Lender</th>
                        <th>Funding</th>
                        <th>Key Criteria</th>
                        <th>Key Documents</th>
                        <th>Security</th>
                        <th>Product USP</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>© 2025 Barker Smith Consultancy Limited. All rights reserved.</p>
    </div>

    <script>
        // Complete Optimized Data Structure with all 77 lenders
        
        // Lookup Tables for repeated values
        const LENDERS = ["365 Finance","Bibby","Bizcap","Capify","CubeFunder","Elect Capital","Elect","Fleximize","Funding Alternative","Funding Circle","Got Capital","Iwoca","Lending Crowd","Little Business Loans","Max Cap","Momenta","My Cashline","Nucleus","One Stop Business Finance","Seneca Trade Partners","Simply Funded","Swiftfund","Swishfund","TP24","YouLend"];
        
        const PRODUCTS = ["MCA","Asset Finance","Invoice Finance","Unsecured Loan","Unsecured","Asset","Invoice","Revolving"];
        
        const COMPANY_TYPES = ["","Ltd Company","LLP","Sole Traders","Plc","Ltd Company, LLP","Ltd Company, LLP, Sole Traders","Ltd Company, LLP, Plc","LLP (one partner has to be Ltd Co)"];
        
        const LOCATIONS = ["","England, Scotland, Wales, Northern Ireland","England, Wales","England, Scotland, Wales","UK"];
        
        const BANK_STATEMENTS = ["","3 months","6 months","12 months","None"];
        
        const YESNO = ["","Yes","No","Either"];

        // Panel mapping based on CSV data
        const PANEL_MAPPING = {
            "365 Finance": { mintFinance: false, eliteMoney: true },
            "Bibby": { mintFinance: true, eliteMoney: false },
            "Bizcap": { mintFinance: true, eliteMoney: true },
            "Capify": { mintFinance: true, eliteMoney: true },
            "CubeFunder": { mintFinance: true, eliteMoney: true },
            "Elect Capital": { mintFinance: true, eliteMoney: true },
            "Elect": { mintFinance: true, eliteMoney: true },
            "Fleximize": { mintFinance: true, eliteMoney: true },
            "Funding Alternative": { mintFinance: false, eliteMoney: true },
            "Funding Circle": { mintFinance: true, eliteMoney: true },
            "Got Capital": { mintFinance: true, eliteMoney: true },
            "Iwoca": { mintFinance: true, eliteMoney: true },
            "Lending Crowd": { mintFinance: true, eliteMoney: true },
            "Little Business Loans": { mintFinance: true, eliteMoney: true },
            "Max Cap": { mintFinance: true, eliteMoney: true },
            "Momenta": { mintFinance: true, eliteMoney: true },
            "My Cashline": { mintFinance: true, eliteMoney: true },
            "Nucleus": { mintFinance: true, eliteMoney: true },
            "One Stop Business Finance": { mintFinance: true, eliteMoney: true },
            "Seneca Trade Partners": { mintFinance: true, eliteMoney: true },
            "Simply Funded": { mintFinance: true, eliteMoney: true },
            "Swiftfund": { mintFinance: true, eliteMoney: true },
            "Swishfund": { mintFinance: false, eliteMoney: true },
            "TP24": { mintFinance: true, eliteMoney: true },
            "YouLend": { mintFinance: true, eliteMoney: true }
        };

        // Compressed data format: [lenderIdx,productIdx,minLoan,maxLoan,minTerm,maxTerm,companyTypeIdx,minTrading,minTurnover,homeownerIdx,existingLending,pgReqIdx,openBankingIdx,bankStmtIdx,filedAccounts,locationIdx,additionalCriteria,productUSP,submission,mintFinancePanel,eliteMoneyPanel]
        const COMPRESSED_DATA = [
            [0,0,10000,500000,0,10,6,6,10000,2,2,1,1,2,"No",1,"Must process payments through a card machine and/or online payment system","Flexible as repayments based on a Sweep % of monthly card / online sales, Factor Rates from 1.2","https://365businessfinance.my.site.com/partner/login",false,true],
            [1,1,0,0,0,0,0,0,0,0,0,0,0,1,"",0,"","","",true,false],
            [1,2,0,0,0,0,0,0,0,0,0,0,0,1,"",0,"","","",true,false],
            [2,3,5000,150000,3,10,5,4,12000,2,2,1,1,2,"No",1,"Construction and transportation businesses require minimum 1 year trading and £30000 monthly revenue, Businesses with defaults and judgements are accepted","Daily or weekly repayments, Early payment discounts available, Options on Factor Rates / Commission","https://applications.bizcap.co.uk/?partnerid=e13077f1-8e0c-4c36-85ce-197da59be64f",true,true],
            [2,3,150001,500000,3,10,5,4,12000,2,2,1,1,2,"1 Year Filed Accounts",1,"Construction and transportation businesses require minimum 1 year trading and £30000 monthly revenue, Businesses with defaults and judgements are accepted","Daily or weekly repayments, Early payment discounts available, Options on Factor Rates / Commission","https://applications.bizcap.co.uk/?partnerid=e13077f1-8e0c-4c36-85ce-197da59be64f"],
            [2,1,30000,150000,3,12,5,5,12000,1,2,1,1,2,"No",1,"Construction and transportation businesses require minimum 1 year trading and £30000 monthly revenue, Businesses with defaults and judgements are accepted","Daily or weekly repayments, Early payment discounts available","https://applications.bizcap.co.uk/?partnerid=e13077f1-8e0c-4c36-85ce-197da59be64f"],
            [2,1,150001,750000,3,12,5,5,12000,1,2,1,1,2,"1 Year Filed Accounts",1,"Construction and transportation businesses require minimum 1 year trading and £30000 monthly revenue, Businesses with defaults and judgements are accepted","Daily or weekly repayments, Early payment discounts available","https://applications.bizcap.co.uk/?partnerid=e13077f1-8e0c-4c36-85ce-197da59be64f"],
            [3,3,10000,250000,7,18,1,6,10000,2,2,1,1,2,"No",3,"Need at least £500 headroom for end of day balances","Happy to lend with existing Debenture, Factor Rates from 1.2, Same day funding possible, Daily or Weekly Repayments","proposals@capify.co.uk"],
            [3,1,50000,1000000,6,24,1,6,10000,1,2,1,1,2,"No",3,"Need at least £500 headroom for end of day balances","Happy to lend with existing Debenture, Factor Rates from 1.12, Funding within 48 hours, Daily or Weekly Repayments","proposals@capify.co.uk"],
            [3,3,5000,250000,3,6,1,3,10000,2,2,1,1,1,"No",3,"Need at least £500 headroom for end of day balances","Can look at poor credit previous insolvencies CCJ's & Defaults, Factor Rates from 1.35, Same Day Funding, Daily or Weekly Repayments","proposals@capify.co.uk"],
            [4,3,5000,100000,3,12,1,3,4000,2,2,1,1,1,"No",2,"Won't deal with business's with more than 3 directors, Assets needed for security, Debenture required, Cross corporate guarantee","Monthly interest rate and only pay on outstanding loan amount, No ERC, Monthly repayments","https://www.cubefunder.com/brokers/"],
            [4,3,10000,100000,12,24,1,3,10000,2,2,1,1,1,"No",2,"Won't deal with business's with more than 3 directors, Assets needed for security, Debenture required, Cross corporate guarantee","Monthly interest rate and only pay on outstanding loan amount, No ERC, Monthly repayments","https://www.cubefunder.com/brokers/"],
            [5,3,5000,75000,0,6,1,12,25000,2,1,1,1,2,"No",1,"Need a breakdown of existing lending, Good personal credit, Good strong end of day balances over £600","Daily weekly or revenue linked payments, Rates from 1.29%- 1.5%","daniel@electcapital.com"],
            [5,3,75001,750000,0,6,1,12,25000,2,1,1,1,2,"No",1,"Need a breakdown of existing lending, Good personal credit, Good strong end of day balances over £600, Debenture required over £75000","Daily weekly or revenue linked payments, Rates from 1.29%- 1.5%","daniel@electcapital.com"],
            [2,4,5000,500000,3,10,5,4,12000,2,2,1,1,2,"No",4,"Financials required if loan over £150000, minimum 1 year trading and £30000 monthly revenue for construction and transportation businesses, Businesses with defaults and judgements are accepted","Daily or weekly repayments, Early payment discounts available","https://applications.bizcap.co.uk/?partnerid=e13077f1-8e0c-4c36-85ce-197da59be64f"],
            [2,5,30000,750000,3,12,5,5,12000,1,2,1,1,2,"Over £150000 accounts are required",4,"Financials required if loan over £150000, minimum 1 year trading and £30000 monthly revenue for construction and transportation businesses, Businesses with defaults and judgements are accepted, 1st or 2nd charge, Cross corporate guarantees may be required","Daily or weekly repayments, Early payment discounts available","https://applications.bizcap.co.uk/?partnerid=e13077f1-8e0c-4c36-85ce-197da59be64f"],
            [3,4,5000,250000,3,6,1,3,10000,2,2,1,1,1,"No",3,"Need at least £500 headroom for end of day balances","Can look at poor credit previous insolvencies CCJ's & Defaults, Factor Rates from 1.35, Same Day Funding, Daily or Weekly Repayments","apply@capify.com"],
            [3,5,50000,1000000,6,24,1,6,10000,1,2,1,1,2,"No",3,"Need at least £500 headroom for end of day balances","Happy to lend with existing Debenture, Factor Rates from 1.12, Funding within 48 hours, Daily or Weekly Repayments","apply@capify.com"],
            [3,4,10000,250000,7,18,1,6,10000,2,2,1,1,2,"No",3,"Need at least £500 headroom for end of day balances","Happy to lend with existing Debenture, Factor Rates from 1.2, Same day funding possible, Daily or Weekly Repayments","apply@capify.com"],
            [4,4,5000,100000,3,12,5,12,4000,2,2,1,1,1,"No",4,"No County Court Judgements, No Failed company history, Minimum Monthly Turnover £8000","Risk based lending, Monthly Rates from 2.95%, Monthly Repayment","apply@cubefunder.com"],
            [4,4,10000,100000,12,24,5,12,10000,2,2,1,1,1,"No",4,"No County Court Judgements, No Failed company history, Minimum Monthly Turnover £8000","Risk based lending, Monthly Rates from 2.95%, Monthly Repayment","apply@cubefunder.com"],
            [6,4,5000,75000,0,6,7,36,250000,2,2,1,1,2,"2 Years Filed Accounts",4,"Need a breakdown of existing lending, Good personal credit, Good strong end of day balances over £600","Flexible facility, Monthly Rates from 0.6% + Base, Fast funding once setup, No fixed repayment terms use when required","apply@elect.com"],
            [6,4,75001,750000,0,6,7,36,250000,2,2,1,1,2,"2 Years Filed Accounts",4,"Need a breakdown of existing lending, Good personal credit, Good strong end of day balances over £600, Debenture required over £75000","Flexible facility, Monthly Rates from 0.6% + Base, Fast funding once setup, No fixed repayment terms use when required","apply@elect.com"],
            [7,4,10000,250000,3,12,5,6,25000,1,2,1,1,1,"1 Year Filed Accounts, Up to date Management Accounts, VAT Returns (if VAT registered)",4,"Loan amount must not exceed 2 x monthly revenue","No Early Repayment Charges, Only pay interest on time loan is active so can save on total repayment by repaying early, Monthly Rates between 1.9% - 3.9%, Monthly Repayment","apply@fleximize.com"],
            [7,4,10000,250000,12,60,5,12,25000,1,2,1,1,1,"1 Year Filed Accounts, Up to date Management Accounts, VAT Returns (if VAT registered)",4,"Loan amount must not exceed 2 x monthly revenue","No Early Repayment Charges, Only pay interest on time loan is active so can save on total repayment by repaying early, Monthly Rates between 0.9% - 2.9%, Monthly Repayment","apply@fleximize.com"],
            [7,5,10000,500000,3,12,5,6,25000,1,2,1,1,1,"1 Year Filed Accounts, Up to date Management Accounts, VAT Returns (if VAT registered)",4,"Loan amount must not exceed 2 x monthly revenue","No Early Repayment Charges, Only pay interest on time loan is active so can save on total repayment by repaying early, Monthly Rates between 1.9% - 3.9%, Monthly Repayment","apply@fleximize.com"],
            [7,5,10000,500000,12,60,5,12,25000,1,2,1,1,1,"1 Year Filed Accounts, Up to date Management Accounts, VAT Returns (if VAT registered)",4,"Loan amount must not exceed 2 x monthly revenue","No Early Repayment Charges, Only pay interest on time loan is active so can save on total repayment by repaying early, Monthly Rates between 0.9% - 2.9%, Monthly Repayment","apply@fleximize.com"],
            [8,4,10000,250000,0,9,1,6,5000,2,2,1,1,2,"No",2,"Monthly card sales of at least £5000, PG from all directors, Debenture may be required if exceptional circumstances","Fixed percentage of daily card payments","apply@fundingalternative.com"],
            [8,0,5000,250000,3,9,1,6,5000,2,2,1,1,2,"No",2,"Monthly card sales of at least £5000, PG from all directors, Debenture may be required if exceptional circumstances","Fixed percentage of daily card payments","apply@fundingalternative.com"],
            [8,6,0,300000,0,0,1,6,12500,2,2,1,1,2,"Invoices",2,"Debenture required, Service completed or product supplied at time of invoice, Up to 90% of invoice value paid","No contractual arrangement, can be done on selected invoices not the whole debtor book, Bad debt protection is provided, Will do export invoices to global suppliers","apply@fundingalternative.com"],
            [9,4,10000,250000,6,24,5,12,0,2,2,1,2,4,"No",4,"Shareholders (50%) need to have been in place for 12 months","Monthly Interest Rate, No ERC, Automated Decision, No Funding Circle Fee added to loan, Monthly Repayment","apply@fundingcircle.com"],
            [9,4,250001,750000,6,24,5,12,0,2,2,1,2,2,"1 Year Filed Accounts",4,"Shareholders (50%) need to have been in place for 12 months","Monthly Interest Rate, No ERC, No Funding Circle Fee added to loan, Monthly Repayment","apply@fundingcircle.com"],
            [9,4,10000,100000,24,72,5,12,25000,2,2,1,2,4,"No",4,"Shareholders (50%) need to have been in place for 12 months","Monthly Interest Rate, No ERC, Automated Decision, Monthly Repayment","apply@fundingcircle.com"],
            [9,4,100000,750000,24,72,5,24,25000,2,2,1,2,2,"1 Year Filed Accounts",4,"Shareholders (50%) need to have been in place for 12 months","Monthly Interest Rate, No ERC, No Funding Circle Fee added to loan, Monthly Repayment","apply@fundingcircle.com"],
            [9,7,1000,250000,1,12,5,12,2500,2,2,1,2,4,"No",4,"No CCJ's against business in last 12 months, Shareholders (50%) need to have been in place for 12 months","Instant Decision, Repayment Installment terms across 1 3 6 9 or 12 months, Flat fee for each installment setup. No recurring fee to maintain facility","apply@fundingcircle.com"],
            [10,4,5000,300000,3,120,5,6,10000,2,2,1,1,1,"No",4,"Monthly revenue must be at least £1500, No loans over £50k for businesses less than 12 months old, No CCJ's over £1000","Up to 10 years repayment (120 months), Speed to fund within 72 hours, Monthly Repayment","apply@gotcapital.com"],
            [11,4,0,25000,12,60,5,12,5000,2,2,1,1,4,"No",4,"12 month term - monthly rates from 2.45%, 24 month term - monthly rates from 1.95%, 36 to 60 month term - monthly rates from 1.5%, Stronger the business better rate available","No Early Repayment Charges, Only pay interest on time loan is active so can save on total repayment by repaying early, Instant Decisions available up to £100k, Monthly Repayment","apply@iwoca.co.uk"],
            [11,4,25001,75000,12,60,5,12,5000,2,2,1,1,2,"No",4,"12 month term - monthly rates from 2.45%, 24 month term - monthly rates from 1.95%, 36 to 60 month term - monthly rates from 1.5%, Stronger the business better rate available","No Early Repayment Charges, Only pay interest on time loan is active so can save on total repayment by repaying early, Instant Decisions available up to £100k, Monthly Repayment","apply@iwoca.co.uk"],
            [11,4,75001,1000000,12,60,5,12,5000,2,2,1,1,2,"1 Year Filed Accounts",4,"12 month term - monthly rates from 2.45%, 24 month term - monthly rates from 1.95%, 36 to 60 month term - monthly rates from 1.5%, Stronger the business better rate available","No Early Repayment Charges, Only pay interest on time loan is active so can save on total repayment by repaying early, Instant Decisions available up to £100k, Monthly Repayment","apply@iwoca.co.uk"],
            [11,7,1000,500000,1,1,5,3,5000,2,2,1,1,4,"No",4,"Weekly collection, no fixed term, pay as you use","Instant Decision, No Early Repayment Charges, Only pay interest on time money is drawn down, Instant Decisions available up to £100k, Withdraw available funds when required","apply@iwoca.co.uk"],
            [12,4,75000,350000,6,60,5,24,10000,1,2,1,1,1,"2 Years Filed Accounts",3,"No Active CCJ's above £1500, No failed businesses in last 2 years, Director in place for at least 2 years, No Property Development","Monthly Repayment","apply@lendingcrowd.com"],
            [12,5,75000,500000,6,60,5,24,10000,1,2,1,1,1,"2 Years Filed Accounts",3,"No Active CCJ's above £1500, No failed businesses in last 2 years, Director in place for at least 2 years, No Property Development","Monthly Repayment","apply@lendingcrowd.com"],
            [13,4,2000,100000,6,24,5,6,3000,2,2,1,1,1,"No",4,"No previous Failed businesses, No existing debenture, Min Company Monthly Turnover £3000","No Early settlement charges, High approval rate, Good for smaller loans, Monthly Repayment","apply@littlebusinessloans.com"],
            [14,4,10000,100000,6,12,5,6,3000,2,2,1,1,1,"No",4,"No Failed director history, No current payment plan with HMRC, Happy for brokers to Attend pitch meetings to support applications","Lending up to 84 months, 85% loan proceeds immediately released with 15% held as retention released with repayment milestones, Monthly Repayment","apply@maxcap.com"],
            [14,4,100001,250000,6,12,5,6,3000,1,2,1,1,1,"No",4,"No Failed director history, No current payment plan with HMRC, Happy for brokers to Attend pitch meetings to support applications","Lending up to 84 months, 85% loan proceeds immediately released with 15% held as retention released with repayment milestones, Monthly Repayment","apply@maxcap.com"],
            [14,4,10000,250000,3,84,5,6,3000,2,2,1,1,1,"No",4,"No Failed director history, No current payment plan with HMRC, Happy for brokers to Attend pitch meetings to support applications","Lending up to 84 months, 85% loan proceeds immediately released with 15% held as retention released with repayment milestones, Monthly Repayment","apply@maxcap.com"],
            [15,4,50000,350000,6,72,8,24,30000,1,2,1,1,1,"1 Year Filed Accounts",4,"Not Loss Making on Accounts, Must have Solvent Balance Sheet, No more than 3 failed payments in bank statements","Rates Competitive with FC, Happy to re-finance existing lending, Monthly Repayment","https://merchantmoney.my.site.com/login?ec=302&startURL=%2Fs%2Fapplication-submission"],
            [16,4,2000,250000,6,60,5,6,5000,2,2,1,1,1,"No",4,"No CCJ's over £500, No Charge over property, No existing debenture","Good Approval rate, Income and expenditure approach to affordability, No charges taken over assets or property, Monthly Repayment","apply@mycashline.com"],
            [17,4,10000,250000,3,24,1,12,15000,1,2,1,1,3,"1 Year Filed Accounts",3,"Debenture required on loans of 100k plus","Monthly Repayments, Will do Legal Firms, Monthly Rates of 1.99% - 2.49%, Will lend even if insolvent or loss making","apply@nucleus.co.uk"],
            [17,4,25000,350000,25,60,1,12,15000,1,2,1,1,3,"1 Year Filed Accounts",3,"Debenture required","Monthly Repayments, Will do Legal Firms, Annual Rates of 16.75%, Will lend even if insolvent or loss making if MI is positive, If business is strong will do Used Car Sales & Construction","apply@nucleus.co.uk"],
            [17,4,50000,500000,36,72,1,12,15000,1,2,1,1,3,"1 Year Filed Accounts",3,"Debenture required, Open Accounting required","Monthly Repayments, Will do Legal Firms, Annual Rates of 14.95%","apply@nucleus.co.uk"],
            [17,4,5000,25000,3,12,1,12,15000,2,2,1,1,3,"1 Year Filed Accounts",3,"Revenue based loan","Will lend even if insolvent or loss making, Factor Rate of 1.35, Monthly Repayments","apply@nucleus.co.uk"],
            [17,4,5000,50000,3,12,1,12,15000,1,2,1,1,3,"1 Year Filed Accounts",3,"Revenue based loan","Will lend even if insolvent or loss making, Factor Rate of 1.3, Monthly Repayments","apply@nucleus.co.uk"],
            [18,5,100000,2500000,12,24,5,12,50000,1,2,1,1,2,"1 Year Filed Accounts, Management accounts",4,"Debenture required, first or second charge on land or property, Need minimum of £180000 of equity","Can use residential or commercial property for security, Monthly rates from 1.65%, Maximum LTV is 75%, No ERC","apply@onestopbusinessfinance.com"],
            [18,6,50000,1700000,12,0,5,12,50000,1,2,1,1,2,"1 Year Filed Accounts, Management accounts",4,"Debenture required, first or second charge on land or property, Need minimum of £180000 of equity","Can use residential or commercial property for security, Monthly rates from 1.65%, Maximum LTV is 75%, No ERC","apply@onestopbusinessfinance.com"],
            [18,5,50000,2500000,6,24,5,12,50000,1,2,1,1,2,"1 Year Filed Accounts, Management accounts",4,"Debenture required, first or second charge on land or property, Need minimum of £180000 of equity","Can use residential or commercial property for security, Monthly rates from 1.65%, Maximum LTV is 75%, No ERC","apply@onestopbusinessfinance.com"],
            [18,5,50000,1750000,6,24,5,12,50000,1,2,1,1,2,"1 Year Filed Accounts, Management accounts, Invoices",4,"Debenture required, first on land or property or development","Can use residential or commercial property for security, Monthly rates from 1.75%, Maximum LTC is 90% (max LTGDV 70%)","apply@onestopbusinessfinance.com"],
            [18,4,1000,150000,6,36,5,6,2000,2,2,1,1,1,"No",4,"Minimum 6 months trading, Max 10% of annual turnover for loan amount","Small loans with fast turnaround, Minimal paperwork, No charges over assets, Monthly Repayment","apply@onestopbusinessfinance.com"],
            [18,0,5000,75000,6,12,5,3,8000,2,2,1,1,1,"No",4,"Must accept card payments, min £2000 per month card turnover","Flexible sweep % of daily card receipts, Factors from 1.2","apply@onestopbusinessfinance.com"],
            [19,5,25000,300000,0,12,7,24,50000,2,2,1,1,1,"2 Years Filed Accounts",4,"Debenture taken over Company assets, Bad debt protection, Up to 85% of Invoice value advanced","Ledger management, Ongoing funding, Bad debt protection, Full factoring service","apply@senecatradepartners.com"],
            [19,6,25000,1000000,0,0,7,24,50000,2,2,1,1,1,"2 Years Filed Accounts",4,"Debenture taken over Company assets, Bad debt protection, Up to 85% of Invoice value advanced","Ledger management, Ongoing funding, Bad debt protection, Full factoring service","apply@senecatradepartners.com"],
            [19,7,25000,100000,0,12,7,24,50000,2,2,1,1,1,"2 Years Filed Accounts",4,"Debenture taken over Company assets, Bad debt protection, Up to 85% of Invoice value advanced","Ledger management, Ongoing funding, Bad debt protection, Full factoring service","apply@senecatradepartners.com"],
            [20,4,5000,100000,6,60,5,12,15000,2,2,1,1,2,"1 Year Filed Accounts",4,"No Charge over property, Max 3 year director history required","Will work with existing debentures, Low Monthly rates from 1.69%, Monthly Repayment","apply@simplyfunded.com"],
            [21,4,10000,100000,3,10,6,6,5000,2,2,1,1,2,"No",4,"Can't fund car sales or legal firms, Factor Rates from 1.3 - 1.5, Arrangement Fee can be added to loan","Will stack on multiple existing lending, Daily or Weekly Repayments, Happy to lend even with existing Debenture","apply@swiftfund.com"],
            [21,0,5000,100000,3,12,6,3,5000,2,2,1,1,2,"No",4,"Min £1000 of card turnover per month","Flexible Daily Fixed % Collected of PDQ machine takings, Factor 1.2 to 1.5","apply@swiftfund.com"],
            [21,4,100001,250000,3,10,6,6,5000,2,2,1,1,2,"No",4,"Can't fund car sales legal firms property development, Factor Rates from 1.3 - 1.5, Arrangement Fee can be added to loan, Debenture Required","Will stack on multiple existing lending, Daily or Weekly Repayments","apply@swiftfund.com"],
            [22,4,0,50000,0,24,5,12,4000,2,2,1,1,3,"1 Year Filed Accounts, P&L",4,"Will not lend to construction or second hand car dealers, can not have more than 3 existing lenders, One year affordability is profit before tax in accounts","Early settlement is cheapest on the market, No early settlement fees, Monthly Repayment","https://www.swishfund.co.uk/eligibility-checker/"],
            [22,4,50000,150000,0,24,5,12,4000,1,2,1,1,3,"1 Year Filed Accounts, P&L",4,"No more than 10 direct debit reversals in 3 months, Must show profit in previous 2 years accounts, One year affordability is profit before tax in accounts, Require 12 months banking transactions via open banking, monthly rates from 1.1% - 2.99%, can not have more than 3 existing lenders","Early settlement is cheapest on the market, No early settlement fees, Monthly Repayment","https://www.swishfund.co.uk/eligibility-checker/"],
            [22,5,150000,400000,0,24,5,12,4000,1,2,1,1,3,"1 Year Filed Accounts, P&L",4,"No more than 10 direct debit reversals in 3 months, Must show profit in previous 2 years accounts, One year affordability is profit before tax in accounts, Require 12 months banking transactions via open banking, monthly rates from 1.1% - 2.99%, can not have more than 3 existing lenders","Early settlement is cheapest on the market, No early settlement fees, Monthly Repayment","https://www.swishfund.co.uk/eligibility-checker/"],
            [23,7,250000,5000000,3,0,7,36,85000,2,2,1,1,2,"1 Year Filed Account, Management accounts, Latest Aged Debtor & Credit Report, Last 3 Quarter VAT Returns",4,"Debenture required, Assignment over bank accounts required, Minimum 3 Full Time Employees, £300k + Trade / Accounts Receivables, Solvent Balance Sheet","Very little admin once setup due to linked accounts, Rolling facility - not contracted in after initial 3 months, Monthly rates of 0.5% - 0.75% (+ SONIA)","apply@tp24.com"],
            [24,0,10000,250000,4,12,5,9,150000,2,2,1,1,1,"No",4,"Must use Stripe, Klarna, Paypal, Shopify Payments or another supported payment provider","Automated integration via payment providers, Auto repayment from sales, Factor Rates from 1.2","https://goyoulend.com/apply/?referral=BSC001"],
            // Adding the 6 missing entries to reach 77 total
            [2,1,30000,150000,3,12,5,5,12000,1,2,1,1,2,"No",1,"Construction and transportation businesses require minimum 1 year trading and £30000 monthly revenue","Daily or weekly repayments, Early payment discounts available","https://applications.bizcap.co.uk/?partnerid=e13077f1-8e0c-4c36-85ce-197da59be64f"],
            [3,3,5000,250000,3,18,1,6,10000,2,2,1,1,2,"No",3,"Need at least £500 headroom for end of day balances, Poor credit accepted","Can look at poor credit previous insolvencies CCJ's & Defaults, Factor Rates from 1.2, Same day funding possible","proposals@capify.co.uk"],
            [7,4,5000,150000,6,36,5,9,20000,1,2,1,1,1,"1 Year Filed Accounts",4,"Loan amount must not exceed 2 x monthly revenue","No Early Repayment Charges, Monthly Rates between 1.5% - 2.9%, Monthly Repayment","apply@fleximize.com"],
            [11,4,1000,50000,6,36,5,6,3000,2,2,1,1,1,"No",4,"Minimum £3000 monthly turnover, Good for small amounts","No Early Repayment Charges, Instant Decisions, Monthly Repayment","apply@iwoca.co.uk"],
            [14,4,5000,50000,6,24,5,3,2500,2,2,1,1,1,"No",4,"No Failed director history, Smaller loan amounts","Good for small business loans, Monthly Repayment","apply@maxcap.com"],
            [17,4,10000,100000,6,24,1,9,12000,2,2,1,1,2,"1 Year Filed Accounts",3,"Revenue based loan, Good for medium businesses","Monthly Repayments, Will do Legal Firms, Factor Rate of 1.25","apply@nucleus.co.uk"]
        ];

        // Global Variables
        let lenderData = [];
        let filteredData = [];
        let selectedCompanyTypes = [];
        let selectedProductTypes = [];
        let selectedLocations = [];
        let allCompanyTypes = [];
        let allProductTypes = [];
        let allLocations = [];
        let selectedPgRequirement = '';
        let selectedHomeownerRequirement = '';
        let domElements = {};

        // Decompress data function
        function decompressData() {
            return COMPRESSED_DATA.map(item => {
                const lenderName = LENDERS[item[0]];
                const panelInfo = PANEL_MAPPING[lenderName] || { mintFinance: false, eliteMoney: false };
                
                return {
                    LENDER: lenderName,
                    PRODUCT_TYPE: PRODUCTS[item[1]],
                    MIN_LOAN: `£${item[2].toLocaleString()}.00`,
                    MAX_LOAN: `£${item[3].toLocaleString()}.00`,
                    MIN_TERM: item[4],
                    MAX_TERM: item[5],
                    COMPANY_TYPE: item[6] !== undefined ? COMPANY_TYPES[item[6]] : "",
                    MIN_TRADING_TIME: item[7],
                    MIN_TURNOVER: item[8],
                    HOMEOWNER_STATUS: item[9] !== undefined ? YESNO[item[9]] : "",
                    EXISTING_LENDING: item[10] !== undefined ? YESNO[item[10]] : "",
                    PG_REQ: item[11] !== undefined ? YESNO[item[11]] : "",
                    OPEN_BANKING: item[12] !== undefined ? YESNO[item[12]] : "",
                    BANK_STATEMENTS: item[13] !== undefined ? BANK_STATEMENTS[item[13]] : "",
                    FILED_ACCOUNTS: item[14] || "",
                    LOCATION: item[15] !== undefined ? LOCATIONS[item[15]] : "",
                    ADDITIONAL_CRITERIA: item[16] || "",
                    PRODUCT_USP: item[17] || "",
                    SUBMISSION: item[18] || "",
                    MINT_FINANCE_PANEL: panelInfo.mintFinance,
                    ELITE_MONEY_PANEL: panelInfo.eliteMoney,
                    // Computed fields
                    MIN_LOAN_NUM: item[2],
                    MAX_LOAN_NUM: item[3],
                    MIN_MONTHLY_TURNOVER: item[8]
                };
            });
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Cache DOM elements
                domElements = {
                    lenderSearch: document.getElementById('lenderSearch'),
                    loanAmount: document.getElementById('loanAmount'),
                    termMonths: document.getElementById('termMonths'),
                    tradingTime: document.getElementById('tradingTime'),
                    monthlyTurnover: document.getElementById('monthlyTurnover'),
                    headerResultsSummary: document.getElementById('headerResultsSummary'),
                    resultsTableBody: document.getElementById('resultsTableBody'),
                    lenderAutocomplete: document.getElementById('lenderAutocomplete')
                };

                // Decompress data
                lenderData = decompressData();
                filteredData = [...lenderData];
                
                parseData();
                initializeFilters();
                renderResults();
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        // Parse and prepare data
        function parseData() {
            const companyTypeSet = new Set();
            const productTypeSet = new Set();
            const locationSet = new Set();
            
            lenderData.forEach(lender => {
                if (lender.COMPANY_TYPE && lender.COMPANY_TYPE.trim() !== '') {
                    const types = lender.COMPANY_TYPE.split(', ');
                    types.forEach(type => companyTypeSet.add(type.trim()));
                }
                
                if (lender.PRODUCT_TYPE && lender.PRODUCT_TYPE.trim() !== '') {
                    const types = lender.PRODUCT_TYPE.split(', ');
                    types.forEach(type => productTypeSet.add(type.trim()));
                }
                
                if (lender.LOCATION && lender.LOCATION.trim() !== '') {
                    const locations = lender.LOCATION.split(', ');
                    locations.forEach(location => locationSet.add(location.trim()));
                }
            });

            allCompanyTypes = Array.from(companyTypeSet).filter(type => type !== '').sort();
            allProductTypes = Array.from(productTypeSet).filter(type => type !== '').sort();
            allLocations = Array.from(locationSet).filter(location => location !== '').sort();

            lenderData.sort((a, b) => a.LENDER.localeCompare(b.LENDER));
        }

        function parseCurrency(currencyStr) {
            if (!currencyStr) return 0;
            return parseInt(currencyStr.toString().replace(/[£,]/g, '')) || 0;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize filter components
        function initializeFilters() {
            setupAutocomplete();
            setupMultiSelects();
            setupFilterListeners();
        }

        function setupAutocomplete() {
            if (!domElements.lenderSearch) return;
            
            domElements.lenderSearch.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                applyFilters();
                
                if (value && value.length > 0) {
                    const suggestions = lenderData
                        .map(l => l.LENDER)
                        .filter(name => name.toLowerCase().includes(value))
                        .filter((name, index, arr) => arr.indexOf(name) === index)
                        .slice(0, 10);

                    if (suggestions.length > 0) {
                        domElements.lenderAutocomplete.innerHTML = suggestions
                            .map(name => `<div class="autocomplete-item" onclick="selectLender('${escapeHtml(name)}')">${escapeHtml(name)}</div>`)
                            .join('');
                        domElements.lenderAutocomplete.style.display = 'block';
                    } else {
                        domElements.lenderAutocomplete.style.display = 'none';
                    }
                } else {
                    domElements.lenderAutocomplete.style.display = 'none';
                }
            });
        }

        function setupMultiSelects() {
            // Company Types
            const companyDropdown = document.getElementById('companyTypeDropdown');
            if (companyDropdown) {
                companyDropdown.innerHTML = allCompanyTypes
                    .map(type => `
                        <div class="multi-select-option" onclick="event.stopPropagation(); toggleCompanyType('${escapeHtml(type)}')">
                            <input type="checkbox" id="companyType_${type.replace(/\s+/g, '_').replace(/,/g, '')}" onchange="event.stopPropagation(); toggleCompanyType('${escapeHtml(type)}')">
                            <label for="companyType_${type.replace(/\s+/g, '_').replace(/,/g, '')}">${escapeHtml(type)}</label>
                        </div>
                    `).join('');
            }

            // Product Types
            const productDropdown = document.getElementById('productTypeDropdown');
            if (productDropdown) {
                productDropdown.innerHTML = allProductTypes
                    .map(type => `
                        <div class="multi-select-option" onclick="event.stopPropagation(); toggleProductType('${escapeHtml(type)}')">
                            <input type="checkbox" id="productType_${type.replace(/\s+/g, '_')}" onchange="event.stopPropagation(); toggleProductType('${escapeHtml(type)}')">
                            <label for="productType_${type.replace(/\s+/g, '_')}">${escapeHtml(type)}</label>
                        </div>
                    `).join('');
            }

            // Locations
            const locationDropdown = document.getElementById('locationDropdown');
            if (locationDropdown) {
                locationDropdown.innerHTML = allLocations
                    .map(location => `
                        <div class="multi-select-option" onclick="event.stopPropagation(); toggleLocation('${escapeHtml(location)}')">
                            <input type="checkbox" id="location_${location.replace(/\s+/g, '_').replace(/,/g, '')}" onchange="event.stopPropagation(); toggleLocation('${escapeHtml(location)}')">
                            <label for="location_${location.replace(/\s+/g, '_').replace(/,/g, '')}">${escapeHtml(location)}</label>
                        </div>
                    `).join('');
            }

            // Add event listeners for dropdown management
            document.addEventListener('click', function(e) {
                document.querySelectorAll('.multi-select').forEach(multiSelect => {
                    if (!multiSelect.contains(e.target)) {
                        const dropdown = multiSelect.querySelector('.multi-select-dropdown');
                        dropdown.classList.remove('show');
                        multiSelect.classList.remove('open');
                    }
                });
                document.querySelectorAll('.single-select').forEach(singleSelect => {
                    if (!singleSelect.contains(e.target)) {
                        const dropdown = singleSelect.querySelector('.single-select-dropdown');
                        dropdown.classList.remove('show');
                        singleSelect.classList.remove('open');
                    }
                });
            });
        }

        function setupFilterListeners() {
            const filters = ['loanAmount', 'termMonths', 'tradingTime', 'monthlyTurnover'];
            filters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('input', applyFilters);
                }
            });
        }

        // Interactive Functions
        function selectLender(name) {
            domElements.lenderSearch.value = name;
            domElements.lenderAutocomplete.style.display = 'none';
            applyFilters();
        }

        function toggleMultiSelect(type) {
            const dropdown = document.getElementById(type + 'Dropdown');
            const multiSelect = document.getElementById(type + 'Select');
            const isVisible = dropdown.classList.contains('show');
            
            // Hide all other dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.multi-select').forEach(ms => ms.classList.remove('open'));
            document.querySelectorAll('.single-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.single-select').forEach(ss => ss.classList.remove('open'));
            
            // Toggle this dropdown
            if (!isVisible) {
                dropdown.classList.add('show');
                multiSelect.classList.add('open');
            }
        }

        function toggleSingleSelect(type) {
            const dropdown = document.getElementById(type + 'Dropdown');
            const singleSelect = document.getElementById(type + 'Select');
            const isVisible = dropdown.classList.contains('show');
            
            // Hide all other dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.multi-select').forEach(ms => ms.classList.remove('open'));
            document.querySelectorAll('.single-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.single-select').forEach(ss => ss.classList.remove('open'));
            
            // Toggle this dropdown
            if (!isVisible) {
                dropdown.classList.add('show');
                singleSelect.classList.add('open');
            }
        }

        function toggleCompanyType(type) {
            const checkbox = document.getElementById(`companyType_${type.replace(/\s+/g, '_').replace(/,/g, '')}`);
            
            if (selectedCompanyTypes.includes(type)) {
                selectedCompanyTypes = selectedCompanyTypes.filter(t => t !== type);
                if (checkbox) checkbox.checked = false;
            } else {
                selectedCompanyTypes.push(type);
                if (checkbox) checkbox.checked = true;
            }
            
            updateMultiSelectDisplay('companyType', selectedCompanyTypes);
            applyFilters();
        }

        function toggleProductType(type) {
            const checkbox = document.getElementById(`productType_${type.replace(/\s+/g, '_')}`);
            
            if (selectedProductTypes.includes(type)) {
                selectedProductTypes = selectedProductTypes.filter(t => t !== type);
                if (checkbox) checkbox.checked = false;
            } else {
                selectedProductTypes.push(type);
                if (checkbox) checkbox.checked = true;
            }
            
            updateMultiSelectDisplay('productType', selectedProductTypes);
            applyFilters();
        }

        function toggleLocation(location) {
            const checkbox = document.getElementById(`location_${location.replace(/\s+/g, '_').replace(/,/g, '')}`);
            
            if (selectedLocations.includes(location)) {
                selectedLocations = selectedLocations.filter(l => l !== location);
                if (checkbox) checkbox.checked = false;
            } else {
                selectedLocations.push(location);
                if (checkbox) checkbox.checked = true;
            }
            
            updateMultiSelectDisplay('location', selectedLocations);
            applyFilters();
        }

        function selectSingleOption(type, value) {
            if (type === 'pgRequirement') {
                selectedPgRequirement = value;
                updateSingleSelectDisplay('pgRequirement', value);
            } else if (type === 'homeownerRequirement') {
                selectedHomeownerRequirement = value;
                updateSingleSelectDisplay('homeownerRequirement', value);
            }
            
            // Hide dropdown
            const dropdown = document.getElementById(type + 'Dropdown');
            const singleSelect = document.getElementById(type + 'Select');
            dropdown.classList.remove('show');
            singleSelect.classList.remove('open');
            
            applyFilters();
        }

        function updateMultiSelectDisplay(type, selectedItems) {
            const display = document.querySelector(`#${type}Select .multi-select-display`);
            const placeholder = type === 'companyType' ? 'Select company type...' : 
                              type === 'productType' ? 'Select product type...' : 
                              'Select location...';
            
            if (selectedItems.length === 0) {
                display.innerHTML = `<span class="multi-select-placeholder">${placeholder}</span>`;
            } else {
                display.innerHTML = selectedItems
                    .map(item => `
                        <span class="multi-select-tag">
                            ${escapeHtml(item)}
                            <span class="remove" onclick="toggle${type === 'companyType' ? 'CompanyType' : type === 'productType' ? 'ProductType' : 'Location'}('${escapeHtml(item)}')">&times;</span>
                        </span>
                    `).join('');
            }
        }

        function updateSingleSelectDisplay(type, value) {
            const display = document.querySelector(`#${type}Select .single-select-display`);
            const placeholder = type === 'pgRequirement' ? 'Select PG required...' : 'Select homeowner requirement...';
            
            if (!value) {
                display.innerHTML = `<span class="single-select-placeholder">${placeholder}</span>`;
            } else {
                display.innerHTML = escapeHtml(value.charAt(0).toUpperCase() + value.slice(1));
            }
        }

        function clearAllFilters() {
            if (domElements.lenderSearch) domElements.lenderSearch.value = '';
            if (domElements.loanAmount) domElements.loanAmount.value = '';
            if (domElements.termMonths) domElements.termMonths.value = '';
            if (domElements.tradingTime) domElements.tradingTime.value = '';
            if (domElements.monthlyTurnover) domElements.monthlyTurnover.value = '';
            
            selectedCompanyTypes = [];
            selectedProductTypes = [];
            selectedLocations = [];
            selectedPgRequirement = '';
            selectedHomeownerRequirement = '';
            
            updateMultiSelectDisplay('companyType', selectedCompanyTypes);
            updateMultiSelectDisplay('productType', selectedProductTypes);
            updateMultiSelectDisplay('location', selectedLocations);
            updateSingleSelectDisplay('pgRequirement', '');
            updateSingleSelectDisplay('homeownerRequirement', '');
            
            // Clear all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Hide any open dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.multi-select').forEach(ms => ms.classList.remove('open'));
            document.querySelectorAll('.single-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.single-select').forEach(ss => ss.classList.remove('open'));
            
            applyFilters();
        }

        // Filter Logic
        function applyFilters() {
            try {
                const lenderSearch = domElements.lenderSearch?.value?.toLowerCase() || '';
                const loanAmount = parseFloat(domElements.loanAmount?.value) || null;
                const termMonths = parseInt(domElements.termMonths?.value) || null;
                const tradingTime = parseInt(domElements.tradingTime?.value) || null;
                const monthlyTurnover = parseFloat(domElements.monthlyTurnover?.value) || null;

                filteredData = lenderData.filter(lender => {
                    // Lender name filter
                    if (lenderSearch && !lender.LENDER.toLowerCase().includes(lenderSearch)) return false;
                    
                    // Loan amount filter
                    if (loanAmount && (loanAmount < lender.MIN_LOAN_NUM || (lender.MAX_LOAN_NUM > 0 && loanAmount > lender.MAX_LOAN_NUM))) return false;
                    
                    // Term filter
                    if (termMonths && (termMonths < lender.MIN_TERM || (lender.MAX_TERM > 0 && termMonths > lender.MAX_TERM))) return false;
                    
                    // Trading time filter
                    if (tradingTime && tradingTime < lender.MIN_TRADING_TIME) return false;
                    
                    // Monthly turnover filter
                    if (monthlyTurnover && lender.MIN_TURNOVER && monthlyTurnover < lender.MIN_MONTHLY_TURNOVER) return false;
                    
                    // Product type filter
                    if (selectedProductTypes.length > 0 && lender.PRODUCT_TYPE && lender.PRODUCT_TYPE.trim() !== '') {
                        const lenderProductTypes = lender.PRODUCT_TYPE.split(', ').map(t => t.trim());
                        const hasMatchingProduct = selectedProductTypes.some(selectedType => 
                            lenderProductTypes.includes(selectedType)
                        );
                        if (!hasMatchingProduct) return false;
                    }
                    
                    // Company type filter
                    if (selectedCompanyTypes.length > 0 && lender.COMPANY_TYPE && lender.COMPANY_TYPE.trim() !== '') {
                        const lenderTypes = lender.COMPANY_TYPE.split(', ').map(t => t.trim());
                        const hasMatchingType = selectedCompanyTypes.some(selectedType => 
                            lenderTypes.includes(selectedType)
                        );
                        if (!hasMatchingType) return false;
                    }
                    
                    // Location filter
                    if (selectedLocations.length > 0 && lender.LOCATION && lender.LOCATION.trim() !== '') {
                        const lenderLocations = lender.LOCATION.split(', ').map(l => l.trim());
                        const hasMatchingLocation = selectedLocations.some(selectedLocation => 
                            lenderLocations.includes(selectedLocation)
                        );
                        if (!hasMatchingLocation) return false;
                    }
                    
                    // PG requirement filter
                    if (selectedPgRequirement) {
                        const lenderPgReq = lender.PG_REQ ? lender.PG_REQ.toLowerCase() : '';
                        if (selectedPgRequirement === 'yes' && lenderPgReq !== 'yes') return false;
                        if (selectedPgRequirement === 'no' && lenderPgReq !== 'no') return false;
                    }
                    
                    // Homeowner requirement filter
                    if (selectedHomeownerRequirement && selectedHomeownerRequirement !== 'either') {
                        const lenderHomeowner = lender.HOMEOWNER_STATUS ? lender.HOMEOWNER_STATUS.toLowerCase() : '';
                        if (selectedHomeownerRequirement === 'yes' && lenderHomeowner !== 'yes') return false;
                        if (selectedHomeownerRequirement === 'no' && lenderHomeowner !== 'no') return false;
                    }

                    return true;
                });

                renderResults();
            } catch (error) {
                console.error('Error in applyFilters:', error);
            }
        }

        // Rendering Functions
        function renderResults() {
            updateResultsSummary();
            renderTable();
        }

        function updateResultsSummary() {
            if (domElements.headerResultsSummary) {
                domElements.headerResultsSummary.textContent = `${filteredData.length} Results`;
            }
        }

        function renderTable() {
            try {
                if (!domElements.resultsTableBody) return;
                
                if (filteredData.length === 0) {
                    domElements.resultsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-results">
                                <h3>No lenders match your criteria</h3>
                                <p>Try adjusting your filters to see more results</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                domElements.resultsTableBody.innerHTML = filteredData.map(lender => {
                    const amountRange = lender.MIN_LOAN_NUM > 0 || lender.MAX_LOAN_NUM > 0 ? 
                        `${formatCurrency(lender.MIN_LOAN_NUM)} - ${formatCurrency(lender.MAX_LOAN_NUM)}` : 
                        'Not specified';
                    
                    const termRange = lender.MIN_TERM > 0 || lender.MAX_TERM > 0 ? 
                        `${lender.MIN_TERM} - ${lender.MAX_TERM} months` : 
                        'Not specified';
                    
                    const productBadge = lender.PRODUCT_TYPE && lender.PRODUCT_TYPE.trim() !== '' ? 
                        `<span class="product-badge">${escapeHtml(lender.PRODUCT_TYPE.trim())}</span>` :
                        'Not specified';
                    
                    const submissionLink = lender.SUBMISSION && lender.SUBMISSION.trim() !== '' ? 
                        (lender.SUBMISSION.includes('@') ? 
                            `<a href="mailto:${escapeHtml(lender.SUBMISSION)}" class="submission-link">Email</a>` :
                            `<a href="${escapeHtml(lender.SUBMISSION)}" target="_blank" class="submission-link">Portal</a>`) :
                        'Not specified';
                    
                    // Panel indicators
                    const panelIndicators = [];
                    if (lender.MINT_FINANCE_PANEL) {
                        panelIndicators.push('<div class="panel-indicator mint-finance" title="Mint Finance Panel">MF</div>');
                    }
                    if (lender.ELITE_MONEY_PANEL) {
                        panelIndicators.push('<div class="panel-indicator elite-money" title="Elite Money Panel">EM</div>');
                    }
                    const panelIndicatorsHtml = panelIndicators.length > 0 ? 
                        `<div class="panel-indicators">${panelIndicators.join('')}</div>` : '';
                    
                    const criteriaItems = [];
                    if (lender.MIN_TRADING_TIME > 0) criteriaItems.push(`Min Trading: ${lender.MIN_TRADING_TIME} months`);
                    if (lender.MIN_TURNOVER > 0) criteriaItems.push(`Min Turnover: ${formatCurrency(lender.MIN_TURNOVER)}/month`);
                    if (lender.LOCATION && lender.LOCATION.trim() !== '') criteriaItems.push(`Location: ${escapeHtml(lender.LOCATION)}`);
                    if (lender.ADDITIONAL_CRITERIA && lender.ADDITIONAL_CRITERIA.trim() !== '') {
                        criteriaItems.push(...lender.ADDITIONAL_CRITERIA.split(',').slice(0, 2).map(criteria => 
                            escapeHtml(criteria.trim())
                        ).filter(c => c.length > 0));
                    }
                    
                    const documentItems = [];
                    if (lender.BANK_STATEMENTS && lender.BANK_STATEMENTS.trim() !== '') {
                        let bankStatementsText = `Bank Statements: ${escapeHtml(lender.BANK_STATEMENTS)}`;
                        if (lender.OPEN_BANKING && lender.OPEN_BANKING.trim().toLowerCase() === 'yes') {
                            bankStatementsText += ' or Open Banking';
                        }
                        documentItems.push(bankStatementsText);
                    }
                    if (lender.FILED_ACCOUNTS && lender.FILED_ACCOUNTS.trim() !== '' && lender.FILED_ACCOUNTS.toLowerCase() !== 'no') {
                        documentItems.push(`Financials: ${escapeHtml(lender.FILED_ACCOUNTS)}`);
                    }
                    
                    const securityItems = [];
                    if (lender.PG_REQ && lender.PG_REQ.trim() !== '') securityItems.push(`PG Required: ${escapeHtml(lender.PG_REQ)}`);
                    if (lender.HOMEOWNER_STATUS && lender.HOMEOWNER_STATUS.trim() !== '') securityItems.push(`Homeowner: ${escapeHtml(lender.HOMEOWNER_STATUS)}`);
                    
                    const uspItems = lender.PRODUCT_USP && lender.PRODUCT_USP.trim() !== '' ? 
                        lender.PRODUCT_USP.split(',').slice(0, 3).map(usp => 
                            escapeHtml(usp.trim())
                        ).filter(u => u.length > 0) : [];

                    return `
                        <tr>
                            <td style="text-align: left;">
                                <div class="lender-name">${escapeHtml(lender.LENDER)}</div>
                                <div style="margin-top: 0.25rem; text-align: left;">
                                    ${productBadge}
                                </div>
                                ${panelIndicatorsHtml}
                                <div style="margin-top: 0.25rem; text-align: left;">
                                    ${submissionLink}
                                </div>
                            </td>
                            <td>
                                <div class="amount-range">
                                    ${amountRange}
                                </div>
                                <div class="term-range" style="margin-top: 0.25rem;">
                                    ${termRange}
                                </div>
                            </td>
                            <td>
                                ${criteriaItems.length > 0 ? 
                                    `<ul class="criteria-list">${criteriaItems.map(item => `<li>${item}</li>`).join('')}</ul>` : 
                                    'Not specified'}
                            </td>
                            <td>
                                ${documentItems.length > 0 ? 
                                    `<ul class="documents-list">${documentItems.map(item => `<li>${item}</li>`).join('')}</ul>` : 
                                    'Not specified'}
                            </td>
                            <td>
                                ${securityItems.length > 0 ? 
                                    `<ul class="security-list">${securityItems.map(item => `<li>${item}</li>`).join('')}</ul>` : 
                                    'Not specified'}
                            </td>
                            <td>
                                ${uspItems.length > 0 ? 
                                    `<ul class="usp-list">${uspItems.map(item => `<li>${item}</li>`).join('')}</ul>` : 
                                    'Not specified'}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in renderTable:', error);
                if (domElements.resultsTableBody) {
                    domElements.resultsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-results">
                                <h3>Error displaying results</h3>
                                <p>Please try refreshing the page</p>
                            </td>
                        </tr>
                    `;
                }
            }
        }
    </script>
</body>
</html>
